
#' @title LoadModel: loading a MOFA model
#' @name loadModel
#' @description Method to load a trained MOFA model from a hdf5 file. \cr
#' Models have to be trained and saved using the corresponding Python package.
#' @param file an hd5f object generated by the MOFA python package.
#' @details fill this
#' @return a \code{\link{MOFAmodel}} object.
#' @import rhdf5
#' @export

loadModel <- function(file) {
  
  # Load expectations and parameters
  expectations <- rhdf5::h5read(file,"expectations")
  parameters <- rhdf5::h5read(file,"parameters")
  
  # Load training statistics
  training_stats <- rhdf5::h5read(file,"training_stats")
  colnames(training_stats$elbo_terms) <- attr(rhdf5::h5read(file,"training_stats/elbo_terms", read.attributes=T),"colnames")
  
  # Load training options
  # training_opts <- as.list(rhdf5::h5read(file,"training_opts", read.attributes=T))
  
  # Load training data
  data <- rhdf5::h5read(file,"data")
  featuredata <- rhdf5::h5read(file,"features")
  sampledata <- rhdf5::h5read(file,"samples")
  for (m in names(data)) {
    rownames(data[[m]]) <- sampledata
    colnames(data[[m]]) <- featuredata[[m]]
  }
  
  # Specify dimensions 
  M=length(data)
  N=nrow(data[[1]])
  D=sapply(data,ncol)
  # K=tail(training_stats$activeK,n=1)
  K=tail(training_stats$activeK[training_stats$activeK!=0],n=1)
  dim=list("M"=M, "N"=N, "D"=D, "K"=K)
  
  
  mofa <- new("MOFAmodel", TrainData=data, TrainStats=training_stats, Expectations=expectations, Parameters=parameters, Dimensions=dim)
  # Create object: important first define dimensionalities and then the other slots
  # mofa <- new("MOFAmodel", Dimensions=dim)
  # .Expectations(mofa) <- expectations
  # .Parameters(mofa) <- parameters
  # .TrainStats(mofa) <- training_stats
  # .TrainData(mofa) <- data
  
  # Define view names
  viewNames(mofa) <- names(data)
  
  # Define sample names
  sampleNames(mofa) <- rownames(data[[1]])
  
  # Define feature names
  featureNames(mofa) <- lapply(data,colnames)

  # Define factor names
  factorNames(mofa) <- as.character(1:K)
    
  return(mofa)
}

