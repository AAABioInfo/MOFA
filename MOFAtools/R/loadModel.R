
#' @title LoadModel: loading a MOFA model
#' @name loadModel
#' @description Method to load a trained MOFA model from a hdf5 file. \cr
#' Models have to be trained and saved using the corresponding Python package.
#' @param file an hd5f object generated by the MOFA python package.
#' @details fill this
#' @return a \code{\link{MOFAmodel}} object.
#' @import rhdf5
#' @export

loadModel <- function(file, view_names=NULL, sample_names=NULL, factor_names=NULL, feature_names=NULL) {
  
  # Load expectations and parameters
  expectations <- rhdf5::h5read(file,"expectations")
  parameters <- rhdf5::h5read(file,"parameters")
  
  # Load training statistics
  training_stats <- rhdf5::h5read(file,"training_stats")
  colnames(training_stats$elbo_terms) <- attr(rhdf5::h5read(file,"training_stats/elbo_terms", read.attributes=T),"colnames")
  
  # Load training options
  # training_opts <- as.list(rhdf5::h5read(file,"training_opts", read.attributes=T))
  
  # Load training data
  data <- rhdf5::h5read(file,"data")
  featuredata <- rhdf5::h5read(file,"features")
  sampledata <- rhdf5::h5read(file,"samples")
  for (m in names(data)) {
    rownames(data[[m]]) <- sampledata
    colnames(data[[m]]) <- featuredata[[m]]
  }
  
  # Specify dimensions 
  M=length(data)
  N=nrow(data[[1]])
  D=sapply(data,ncol)
  K=tail(training_stats$activeK,n=1)
  dim=list("M"=M, "N"=N, "D"=D, "K"=K)
  
  
  # Create object: important first define dimensionalities and then the other slots
  mofa <- new("MOFAmodel", TrainData=data, TrainStats=training_stats, Expectations=expectations, Parameters=parameters, Dimensions=dim)
  # mofa <- new("MOFAmodel", Dimensions=dim)
  # .Expectations(mofa) <- expectations
  # .Parameters(mofa) <- parameters
  # .TrainStats(mofa) <- training_stats
  # .TrainData(mofa) <- data
  
  # If provided, define view names
  if (!is.null(view_names)) {
    viewNames(mofa) <- view_names
  } else {
    viewNames(mofa) <- as.character(1:dim[["M"]])
  }
  
  # If provided, define sample names
  if (!is.null(sample_names)) {
    sampleNames(mofa) <- sample_names
  } else {
    sampleNames(mofa) <- as.character(1:dim[["N"]])
  }
  
  # If provided, define feature names
  if (!is.null(feature_names)) {
    featureNames(mofa) <- feature_names
  } else {
    featureNames(mofa) <- lapply(dim[["D"]], function(d) as.character(1:d))
  }
  
  # If provided, define factor names
  if (!is.null(factor_names)) {
    factorNames(mofa) <- factor_names
  } else {
    factorNames(mofa) <- as.character(1:dim[["K"]])
  }
  
  return(mofa)
}

