
############################################
## Functions to load a trained MOFA model ##
############################################


#' @title loadModel: loading a trained MOFA model from python output
#' @name loadModel
#' @description Method to load a trained MOFA model from a hdf5 file. \cr
#' Models have to be trained and saved using the corresponding Python package.
#' @param file an hd5f model generated by the MOFA python package.
#' @param object an existing (usually untrained) MOFA object to load trained object into
#' @param sortFactors: boolean, if true factors are sorted by variance explained
#' @details fill this
#' @return a \code{\link{MOFAmodel}} model.
#' @importFrom rhdf5 h5read
#' @export

loadModel <- function(file, object = NULL, sortFactors = T) {
  
  # message(paste0("Loading the following MOFA model: ", file))
  
  if (is.null(object)) object <- new("MOFAmodel")
  
  # if(.hasSlot(object,"Status") & length(object@Status) !=0)
  #   if (object@Status == "trained") warning("The specified object is already trained, over-writing training output with new results!")
  
  # Load expectations and parameters
  object@Expectations <- h5read(file,"expectations")
  object@Parameters <- h5read(file,"parameters")
  object@Status <- "trained"
  
  # Load training statistics
  tryCatch( {
    object@TrainStats <- h5read(file, 'training_stats',read.attributes=T);
    colnames(object@TrainStats$elbo_terms) <- attr(h5read(file,"training_stats/elbo_terms", read.attributes=T),"colnames")
  }, error = function(x) { print("Training stats not found, not loading it...") })

  
  # Load training options
  if (length(object@TrainOpts) == 0) {
    tryCatch(object@TrainOpts <- as.list(h5read(file, 'training_opts',read.attributes=T)), error = function(x) { print("Training opts not found, not loading it...") })
  }
    
  # Load model options
  if (length(object@ModelOpts) == 0) {
    tryCatch(object@ModelOpts <- as.list(h5read(file, 'model_opts',read.attributes=T)), error = function(x) { print("Model opts not found, not loading it...") })
  }
  
  # TO REMOVE
  if ("learnMean" %in% names(object@ModelOpts)) {
    tmp <- names(object@ModelOpts)
    tmp[tmp=="learnMean"] <- "learnIntercept"
    names(object@ModelOpts) <- tmp
  }
  object@ModelOpts$learnIntercept <- as.logical(object@ModelOpts$learnIntercept)
  
  # Load training data
  tryCatch( {
    TrainData <- h5read(file,"data")
    featureData <- h5read(file,"features")
    sampleData <- h5read(file,"samples")
    for (m in names(TrainData)) {
      rownames(TrainData[[m]]) <- sampleData
      colnames(TrainData[[m]]) <- featureData[[m]]
      TrainData[[m]][is.nan(TrainData[[m]])] <- NA
    }
    TrainData <- lapply(TrainData, t)
    object@TrainData <- TrainData
    }, error = function(x) { print("Error loading the training data...") })
  
  
  # Load dimensions and names
  object@Dimensions[["M"]] <- length(object@TrainData)
  object@Dimensions[["N"]] <- ncol(object@TrainData[[1]])
  object@Dimensions[["D"]] <- sapply(object@TrainData,nrow)
  # K=tail(training_stats$activeK[!is.nan(training_stats$activeK)],n=1)
  object@Dimensions[["K"]] <- ncol(object@Expectations$Z$E)
  viewNames(object) <- names(object@TrainData)
  MOFAtools::sampleNames(object) <- colnames(object@TrainData[[1]])
  MOFAtools::featureNames(object) <- lapply(object@TrainData,rownames)
  factorNames(object) <- as.character(1:object@Dimensions[["K"]])
    
  # Rename covariates, including intercept
  # if (object@ModelOpts$learnIntercept == TRUE) factorNames(object) <- c("intercept",as.character(1:(object@Dimensions[["K"]]-1)))
  # if (!is.null(object@ModelOpts$covariates)) {
  #   if (object@ModelOpts$learnIntercept == TRUE) {
  #     factorNames(object) <- c("intercept", colnames(object@ModelOpts$covariates), as.character((ncol(object@ModelOpts$covariates)+1:(object@Dimensions[["K"]]-1-ncol(object@ModelOpts$covariates)))))
  #   } else {
  #     factorNames(object) <- c(colnames(object@ModelOpts$covariates), as.character((ncol(object@ModelOpts$covariates)+1:(object@Dimensions[["K"]]-1))))
  #   }
  # }
  if (object@ModelOpts$learnIntercept == TRUE) {
    intercept_idx <- names(which(sapply(apply(object@Expectations$Z$E,2,unique),length)==1))
    factornames <- as.character(1:(object@Dimensions[["K"]]))
    factornames[factornames==intercept_idx] <- "intercept"
    factorNames(object) <- factornames
    # object@Dimensions[["K"]] <- object@Dimensions[["K"]] - 1
  }
  if (!is.null(object@ModelOpts$covariates)) {
    stop("Not working")
  }
  
  if ((object@Dimensions$K-as.numeric(object@ModelOpts$learnIntercept))>0) {
    # Mask pasenger factors and set to NA
    # object <- detectPassengers(object)
  
    # Re-name and order factors in order of variance explained
    if (sortFactors == T) {
      r2 <- rowSums(calculateVarianceExplained(object,plotit=F,showtotalR2=T)$R2PerFactor)
      order_factors <- c(names(r2)[order(r2, decreasing = T)])
      if (object@ModelOpts$learnIntercept==T) { order_factors <- c("intercept",order_factors) }
      object <- subsetFactors(object,order_factors)
      if (object@ModelOpts$learnIntercept==T) { 
        factorNames(object) <- c("intercept",1:(object@Dimensions$K-1))
      } else {
        factorNames(object) <- c(1:object@Dimensions$K) 
      }
    }
    return(object)
  } else {
    stop("The model has no active factors")
  }
}

