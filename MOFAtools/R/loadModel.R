
#' @title LoadModel: loading a MOFA model
#' @name loadModel
#' @description Method to load a trained MOFA model from a hdf5 file. \cr
#' Models have to be trained and saved using the corresponding Python package.
#' @param file an hd5f object generated by the MOFA python package.
#' @details fill this
#' @return a \code{\link{MOFAmodel}} object.
#' @import rhdf5
#' @export

loadModel <- function(file) {
  
  model <- new("MOFAmodel")
  
  # Load expectations and parameters
  model@Expectations <- rhdf5::h5read(file,"expectations")
  model@Parameters <- rhdf5::h5read(file,"parameters")
  
  # Load training statistics
  tryCatch( {
    model@TrainStats <- rhdf5::h5read(file, 'training_stats',read.attributes=T);
    colnames(model@TrainStats$elbo_terms) <- attr(rhdf5::h5read(file,"training_stats/elbo_terms", read.attributes=T),"colnames")
  }, error = function(x) { print("Training stats not found, not loading it...") })

  
  # Load training options
  tryCatch(model@TrainOpts <- as.list(rhdf5::h5read(file, 'training_opts',read.attributes=T)), error = function(x) { print("Training opts not found, not loading it...") })
  
  # Load model options
  tryCatch(model@ModelOpts <- as.list(rhdf5::h5read(file, 'model_opts',read.attributes=T)), error = function(x) { print("Model opts not found, not loading it...") })
  
  # Load training data
  tryCatch( {
    model@TrainData <- rhdf5::h5read(file,"data")
    featuredata <- rhdf5::h5read(file,"features")
    sampledata <- rhdf5::h5read(file,"samples")
    for (m in names(model@TrainData)) {
      rownames(model@TrainData[[m]]) <- sampledata
      colnames(model@TrainData[[m]]) <- featuredata[[m]]
    }
    model@Dimensions[["M"]] <- length(model@TrainData)
    model@Dimensions[["N"]] <- nrow(model@TrainData[[1]])
    model@Dimensions[["D"]] <- sapply(model@TrainData,ncol)
    model@Dimensions[["K"]] <- ncol(model@Expectations$Z$E)
    viewNames(model) <- names(model@TrainData)
    sampleNames(model) <- rownames(model@TrainData[[1]])
    featureNames(model) <- lapply(model@TrainData,colnames)
    factorNames(model) <- as.character(1:model@Dimensions[["K"]])
    # K=tail(training_stats$activeK[!is.nan(training_stats$activeK)],n=1)
    }, error = function(x) { print("Error loading the data...") })

    
  return(model)
}

